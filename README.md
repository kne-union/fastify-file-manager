
# fastify-file-manager


### æè¿°

ç”¨äºç®¡ç†é™æ€æ–‡ä»¶ä¸Šä¼ æŸ¥çœ‹ç­‰


### å®‰è£…

```shell
npm i --save @kne/fastify-file-manager
```


### æ¦‚è¿°

### é¡¹ç›®æ¦‚è¿°

Fastify File Manager æ˜¯ä¸€ä¸ªåŸºäº Fastify æ¡†æ¶æ„å»ºçš„é«˜æ€§èƒ½æ–‡ä»¶ç®¡ç†æœåŠ¡ï¼Œæä¾›æ–‡ä»¶ä¸Šä¼ ã€å­˜å‚¨ã€æ£€ç´¢å’Œç®¡ç†åŠŸèƒ½ã€‚è¯¥é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒå¤šç§å­˜å‚¨åç«¯ï¼ŒåŒ…æ‹¬æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå’Œäº‘å­˜å‚¨æœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘OSSã€AWS S3ç­‰ï¼‰ã€‚

#### æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½æ–‡ä»¶å¤„ç†**ï¼šåŸºäº Fastify çš„è½»é‡çº§æ¶æ„
- ğŸ”’ **å®‰å…¨è®¤è¯**ï¼šé›†æˆ JWT è®¤è¯å’Œæƒé™æ§åˆ¶
- ğŸ“ **å¤šå­˜å‚¨æ”¯æŒ**ï¼šå¯é…ç½®æœ¬åœ°å­˜å‚¨æˆ–äº‘å­˜å‚¨
- ğŸ·ï¸ **æ–‡ä»¶åˆ†ç±»**ï¼šé€šè¿‡å‘½åç©ºé—´(namespace)ç»„ç»‡æ–‡ä»¶
- ğŸ“Š **å…ƒæ•°æ®ç®¡ç†**ï¼šè®°å½•æ–‡ä»¶å¤§å°ã€ç±»å‹ã€ä¸Šä¼ æ—¶é—´ç­‰ä¿¡æ¯
- ğŸ” **æ–‡ä»¶æ£€ç´¢**ï¼šæ”¯æŒæŒ‰å‘½åç©ºé—´æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨



### ç¤ºä¾‹

#### ç¤ºä¾‹ä»£ç 



### API

| å‚æ•°                          | ç±»å‹       | é»˜è®¤å€¼                                  | å¿…å¡« | æè¿°                                                                  |
|-----------------------------|----------|--------------------------------------|----|---------------------------------------------------------------------|
| **åŸºç¡€é…ç½®**                    |          |                                      |    |                                                                     |
| `root`                      | string   | `path.join(process.cwd(), 'static')` | å¦  | æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½•è·¯å¾„                                                           |
| `namespace`                 | string   | `'default'`                          | å¦  | é»˜è®¤æ–‡ä»¶åˆ†ç±»å‘½åç©ºé—´                                                          |
| `prefix`                    | string   | `/api/v${majorVersion}/static`       | å¦  | APIè·¯ç”±å‰ç¼€ï¼Œè‡ªåŠ¨ä»package.jsonæå–ä¸»ç‰ˆæœ¬å·                                       |
| `dbTableNamePrefix`         | string   | `'t_file_manager_'`                  | å¦  | æ•°æ®åº“è¡¨åå‰ç¼€                                                             |
| **æ–‡ä»¶ä¸Šä¼ **                    |          |                                      |    |                                                                     |
| `multipart.limits.fileSize` | number   | `524288000` (500MB)                  | å¦  | å•ä¸ªæ–‡ä»¶æœ€å¤§ä¸Šä¼ å¤§å°                                                          |
| **é™æ€æ–‡ä»¶æœåŠ¡**                  |          |                                      |    |                                                                     |
| `static`                    | object   | `{}`                                 | å¦  | é€ä¼ [@fastify/static](https://github.com/fastify/fastify-static)çš„æ‰€æœ‰é…ç½® |
| **é€‚é…å™¨é…ç½®**                   |          |                                      |    |                                                                     |
| `ossAdapter`                | function | `() => {}`                           | å¦  | OSSé€‚é…å™¨å·¥å‚å‡½æ•°ï¼Œéœ€è¿”å›OSSé…ç½®å¯¹è±¡                                               |
| `createAuthenticate`        | function | `() => []`                           | å¦  | è®¤è¯ä¸­é—´ä»¶å·¥å‚å‡½æ•°                                                           |

### é…ç½®ç¤ºä¾‹

```javascript
const options = {
    root: '/data/uploads',  // è‡ªå®šä¹‰å­˜å‚¨ç›®å½•
    namespace: 'user_files', // ä¸šåŠ¡éš”ç¦»å‘½åç©ºé—´
    multipart: {
        limits: {
            fileSize: 100 * 1024 * 1024 // è°ƒæ•´ä¸º100MB
        }
    },
    ossAdapter: () => {
        /** éœ€è¦æ³¨å†Œ '@kne/fastify-aliyun' æ’ä»¶
         * fastify.register(require('@kne/fastify-aliyun'), {
         prefix: `${apiPrefix}/aliyun`,
         oss: {
         baseDir: 'leapin-setting',
         region: fastify.config.OSS_REGION,
         accessKeyId: fastify.config.OSS_ACCESS_KEY_ID,
         accessKeySecret: fastify.config.OSS_ACCESS_KEY_SECRET,
         bucket: fastify.config.OSS_BUCKET
         }
         });
         * */
        return fastify.aliyun.services.oss;
    },
    createAuthenticate: (requiredPermission) => [
        fastify.jwtVerify,
        checkPermission(requiredPermission)
    ]
}
```

### é…ç½®è¯´æ˜

1. **ç‰ˆæœ¬å…¼å®¹æ€§**  
   `prefix` è‡ªåŠ¨ä» `package.json` æå–ä¸»ç‰ˆæœ¬å·ï¼ˆå¦‚ `1.2.3` â†’ `/api/v1/static`ï¼‰

2. **å­˜å‚¨ç›®å½•**
    - é»˜è®¤ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `static` æ–‡ä»¶å¤¹
    - ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ä¸ºç»å¯¹è·¯å¾„ï¼ˆå¦‚ `/var/www/uploads`ï¼‰

3. **æƒé™æ§åˆ¶**  
   `createAuthenticate` åº”è¿”å› Fastify é’©å­æ•°ç»„ï¼Œå…¸å‹å®ç°ï¼š
   ```javascript
   createAuthenticate: (perm) => [
     fastify.authenticate,
     (req, reply, done) => {
       if(!req.user.permissions.includes(perm)) {
         return reply.code(403).send()
       }
       done()
     }
   ]
   ```

### æ–‡ä»¶ä¸Šä¼ æ¥å£

#### `POST /api/v1/static/upload`

ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨æˆ–é…ç½®çš„å­˜å‚¨æœåŠ¡

##### è®¤è¯è¦æ±‚

- éœ€è¦ `file:write` æƒé™
- é€šè¿‡ JWT è®¤è¯

##### è¯·æ±‚å‚æ•°

| å‚æ•°        | ä½ç½®    | ç±»å‹     | å¿…å¡« | æè¿°       | ç¤ºä¾‹             |
|-----------|-------|--------|----|----------|----------------|
| namespace | query | string | å¦  | æ–‡ä»¶åˆ†ç±»å‘½åç©ºé—´ | `user-avatars` |
| file      | body  | file   | æ˜¯  | è¦ä¸Šä¼ çš„æ–‡ä»¶   | -              |

##### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X POST \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -F "file=@test.jpg" \
  "http://localhost:3000/api/v1/static/upload?namespace=user-avatars"
```

##### å“åº”çŠ¶æ€ç 

| çŠ¶æ€ç  | æè¿°        |
|-----|-----------|
| 200 | æ–‡ä»¶ä¸Šä¼ æˆåŠŸ    |
| 400 | æ— æ•ˆè¯·æ±‚æˆ–ç¼ºå°‘æ–‡ä»¶ |
| 401 | æœªæˆæƒè®¿é—®     |
| 413 | æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶  |
| 500 | æœåŠ¡å™¨é”™è¯¯     |

---

### æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢

#### `POST /api/v1/static/file-list`

æŸ¥è¯¢æŒ‡å®šæ¡ä»¶ä¸‹çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œç­›é€‰ï¼‰

#### è®¤è¯è¦æ±‚

- éœ€è¦ `file:mange` æƒé™
- é€šè¿‡ JWT è®¤è¯

#### è¯·æ±‚å‚æ•°

##### Body å‚æ•° (application/json)

| å‚æ•°                 | ç±»å‹       | å¿…å¡« | æè¿°                  | é»˜è®¤å€¼ | ç¤ºä¾‹                |
|--------------------|----------|----|---------------------|-----|-------------------|
| `perPage`          | number   | å¦  | æ¯é¡µæ˜¾ç¤ºæ•°é‡              | 20  | `10`              |
| `currentPage`      | number   | å¦  | å½“å‰é¡µç                 | 1   | `2`               |
| `filter`           | object   | å¦  | ç­›é€‰æ¡ä»¶                | -   | -                 |
| `filter.namespace` | string   | å¦  | æ–‡ä»¶åˆ†ç±»å‘½åç©ºé—´            | -   | `"user-docs"`     |
| `filter.size`      | number[] | å¦  | æ–‡ä»¶å¤§å°èŒƒå›´[min,max]ï¼ˆå­—èŠ‚ï¼‰ | -   | `[1024, 1048576]` |
| `filter.filename`  | string   | å¦  | æ–‡ä»¶åæ¨¡ç³ŠåŒ¹é…             | -   | `"report.pdf"`    |

##### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X POST \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "perPage": 10,
    "currentPage": 2,
    "filter": {
      "namespace": "project-files",
      "size": [1024, 1048576],
      "filename": "report"
    }
  }' \
  "http://localhost:3000/api/v1/static/file-list"
```

##### å“åº”çŠ¶æ€ç 

| çŠ¶æ€ç  | æè¿°      |
|-----|---------|
| 200 | æŸ¥è¯¢æˆåŠŸ    |
| 400 | å‚æ•°éªŒè¯å¤±è´¥  |
| 401 | æœªæˆæƒè®¿é—®   |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

##### ç­›é€‰é€»è¾‘è¯´æ˜

1. **å‘½åç©ºé—´ç­›é€‰**ï¼šç²¾ç¡®åŒ¹é…ä¼ å…¥çš„ `namespace` å€¼
2. **æ–‡ä»¶å¤§å°ç­›é€‰**ï¼š
    - æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºæœ€å°å€¼
    - æ•°ç»„ç¬¬äºŒä¸ªå…ƒç´ ä¸ºæœ€å¤§å€¼
3. **æ–‡ä»¶åç­›é€‰**ï¼šä½¿ç”¨ `LIKE %value%` æ¨¡ç³ŠåŒ¹é…

##### åˆ†é¡µè¯´æ˜

- åˆ†é¡µè®¡ç®—ï¼š`offset = (currentPage - 1) * perPage`
- å»ºè®®æ¯é¡µæ•°é‡ä¸è¶…è¿‡ 100 æ¡
- é¡µç ä» 1 å¼€å§‹è®¡æ•°

---

### æ–‡ä»¶åˆ é™¤æ¥å£

#### `DELETE /api/v1/static/:fileId`

åˆ é™¤æŒ‡å®šæ–‡ä»¶

##### è®¤è¯è¦æ±‚

- éœ€è¦ `file:write` æƒé™

##### è¯·æ±‚å‚æ•°

| å‚æ•°     | ä½ç½®   | ç±»å‹     | å¿…å¡« | æè¿°       | ç¤ºä¾‹       |
|--------|------|--------|----|----------|----------|
| fileId | path | string | æ˜¯  | è¦åˆ é™¤çš„æ–‡ä»¶ID | `abc123` |

##### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X DELETE \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  "http://localhost:3000/api/v1/static/abc123"
```

##### å“åº”çŠ¶æ€ç 

| çŠ¶æ€ç  | æè¿°     |
|-----|--------|
| 204 | æ–‡ä»¶åˆ é™¤æˆåŠŸ |
| 404 | æ–‡ä»¶ä¸å­˜åœ¨  |
| 500 | æœåŠ¡å™¨é”™è¯¯  |

---

### æ–‡ä»¶ä¿¡æ¯æ¥å£

#### `GET /api/v1/static/:fileId`

è·å–æ–‡ä»¶è¯¦ç»†ä¿¡æ¯

##### è®¤è¯è¦æ±‚

- éœ€è¦ `file:read` æƒé™

##### è¯·æ±‚å‚æ•°

| å‚æ•°     | ä½ç½®   | ç±»å‹     | å¿…å¡« | æè¿°       | ç¤ºä¾‹       |
|--------|------|--------|----|----------|----------|
| fileId | path | string | æ˜¯  | è¦æŸ¥è¯¢çš„æ–‡ä»¶ID | `abc123` |

##### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X GET \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  "http://localhost:3000/api/v1/static/abc123"
```

##### å“åº”ç¤ºä¾‹

```json
{
  "id": "abc123",
  "name": "document.pdf",
  "size": 102400,
  "mimeType": "application/pdf",
  "createdAt": "2023-01-01T00:00:00Z",
  "url": "/api/v1/static/file/documents/abc123.pdf"
}
```

---

### æ¥å£ä½¿ç”¨è¯´æ˜

1. **è®¤è¯æ–¹å¼**ï¼š
    - æ‰€æœ‰æ¥å£éƒ½éœ€è¦åœ¨ Header ä¸­æ·»åŠ  `Authorization: Bearer <JWT_TOKEN>`
    - JWT éœ€è¦åŒ…å«ç›¸åº”çš„æƒé™å£°æ˜

2. **å‘½åç©ºé—´è§„åˆ™**ï¼š
    - å‘½åç©ºé—´æ”¯æŒå­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„åˆ
    - æœªæŒ‡å®šæ—¶ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´

3. **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼š
    - é»˜è®¤æœ€å¤§ 500MB
    - å¯åœ¨æœåŠ¡ç«¯é…ç½®ä¸­è°ƒæ•´

4. **é”™è¯¯å¤„ç†**ï¼š
    - æ‰€æœ‰é”™è¯¯å“åº”éƒ½åŒ…å«æ ‡å‡†æ ¼å¼çš„ error å­—æ®µ
    - å®¢æˆ·ç«¯åº”æ£€æŸ¥çŠ¶æ€ç è€Œéä»…ä¾èµ–å“åº”ä½“

> æ³¨æ„ï¼šå®é™… API è·¯å¾„å‰ç¼€ä¼šæ ¹æ®é…ç½®çš„ `prefix` å‚æ•°å˜åŒ–
